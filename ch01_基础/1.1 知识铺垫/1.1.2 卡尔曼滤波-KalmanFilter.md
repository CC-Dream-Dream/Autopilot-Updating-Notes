### 1.1.2 卡尔曼滤波-KalmanFilter

#### 1.1.2.1 简介
对于这个滤波器，我们几乎可以下这么一个定论：只要是存在不确定信息的动态系统，卡尔曼滤波就可以对系统下一步要做什么做出有根据的推测。即便有噪声信息干扰，卡尔曼滤波通常也能很好的弄清楚究竟发生了什么，找出现象间不易察觉的相关性。

因此卡尔曼滤波非常适合不断变化的系统，它的优点还有内存占用较小（只需保留前一个状态）、速度快，是实时问题和嵌入式系统的理想选择。

如果你曾经Google过卡尔曼滤波的教程（如今有一点点改善），你会发现相关的算法教程非常可怕，而且也没具体说清楚是什么。事实上，卡尔曼滤波很简单，如果我们以正确的方式看它，理解是很水到渠成的事。

本文会用大量清晰、美观的图片和颜色来解释这个概念，读者只需具备概率论和矩阵的一般基础知识。

#### 1.1.2.2 机器人实例分析
**一、场景**

一个可以在树林里四处溜达的小机器人，为了让它实现导航，机器人需要知道自己所处的位置。
<div align=center>
<img src="./imgs/1.1.2.1.jpg" width="300" height="150">
</div>
<div align=center>图1. 机器人</div>

也就是说，机器人有一个包含位置信息和速度信息的状态 ${\vec{x}_k}$ :

$$ {\vec{x}_k} = (\vec{p}, \vec{v}) $$

注意，在这个例子中，状态是位置和速度，放进其他问题里，它也可以是水箱里的液体体积、汽车引擎温度、触摸板上指尖的位置，或者其他任何数据。

我们的小机器人装有GPS传感器，定位精度10米。虽然一般来说这点精度够用了，但我们希望它的定位误差能再小点，毕竟树林里到处都是土坑和陡坡，如果机器人稍稍偏了那么几米，它就有可能滚落山坡。所以GPS提供的信息还不够充分。

<div align=center>
<img src="./imgs/1.1.2.2.jpg" width="300" height="200">
</div>
<div align=center>图2. 偏离位置</div>

我们也可以预测机器人是怎么移动的：它会把指令发送给控制轮子的马达，如果这一刻它始终朝一个方向前进，没有遇到任何障碍物，那么下一刻它可能会继续坚持这个路线。但是机器人对自己的状态不是全知的：它可能会逆风行驶，轮子打滑，滚落颠簸地形……所以车轮转动次数并不能完全代表实际行驶距离，基于这个距离的预测也不完美。

这个问题下，GPS为我们提供了一些关于状态的信息，但那是间接的、不准确的；我们的预测提供了关于机器人轨迹的信息，但那也是间接的、不准确的。

但以上就是我们能够获得的全部信息，在它们的基础上，我们是否能给出一个完整预测，让它的准确度比机器人搜集的单次预测汇总更高？用了卡尔曼滤波，这个问题可以迎刃而解。

**二、相关性分析**

还是上面这个问题，我们有一个状态，它和速度、位置有关：

$$
{\vec{x}_k} = 
\left[
\begin{matrix}
p \\
v \\
\end{matrix}
\right]
$$

我们不知道它们的实际值是多少，但掌握着一些速度和位置的可能组合，其中某些组合的可能性更高：

<div align=center>
<img src="./imgs/1.1.2.3.jpg" width="300" height="250">
</div>
<div align=center>图3. 状态分布</div>

卡尔曼滤波假设两个变量（在我们的例子里是位置和速度）都应该是随机的，而且符合高斯分布。每个变量都有一个均值 $\mu$ ，它是随机分布的中心；有一个方差 $\sigma^2$ ，它衡量组合的不确定性。
<div align=center>
<img src="./imgs/1.1.2.4.jpg" width="300" height="250">
</div>
<div align=center>图4. 变量不相关分布</div>
在上图中，位置和速度是不相关的，这意味着我们不能从一个变量推测另一个变量。那么如果位置和速度相关呢？如下图所示，机器人前往特定位置的可能性取决于它拥有的速度。
<div align=center>
<img src="./imgs/1.1.2.5.jpg" width="300" height="250">
</div>
<div align=center>图5. 变量相关分布</div>

这不难理解，如果基于旧位置估计新位置，我们会产生这两个结论：如果速度很快，机器人可能移动得更远，所以得到的位置会更远；如果速度很慢，机器人就走不了那么远。

这种关系对目标跟踪来说非常重要，因为它提供了更多信息：一个可以衡量可能性的标准。这就是卡尔曼滤波的目标：从不确定信息中挤出尽可能多的信息！

为了捕获这种相关性，我们用的是协方差矩阵。简而言之，矩阵的每个值是第 $i$ 个变量和第 $j$ 个变量之间的相关程度（由于矩阵是对称的， $i$ 和 $j$ 的位置可以随便交换）。我们用 $\Sigma$ 表示协方差矩阵，在这个例子中，就是 $\Sigma_{ij}$ 。

<div align=center>
<img src="./imgs/1.1.2.6.jpg" width="300" height="250">
</div>
<div align=center>图6. 协方差矩阵表示</div>

**三、矩阵描述**

为了把以上关于状态的信息建模为高斯分布（图中色块），我们还需要 $k$ 时的两个信息：最佳估计 $\hat{x_k}$ （均值，也就是 $\mu$ ），协方差矩阵 ${P_k}$ 。（虽然还是用了位置和速度两个变量，但只要和问题相关，卡尔曼滤波可以包含任意数量的变量）

$$
{\hat{x}_k} = 
\left[
\begin{matrix}
position \\
velocity \\
\end{matrix}
\right]
$$ 

$$
{P_k} = 
\left[
\begin{matrix}
\Sigma_{pp} & \Sigma_{pv} \\
\Sigma_{vp} & \Sigma_{vv} \\
\end{matrix}
\right]
$$

接下来，我们要通过查看当前状态（k-1 时）来预测下一个状态（k 时）。这里我们查看的状态不是真值，但预测函数无视真假，可以给出新分布：

<div align=center>
<img src="./imgs/1.1.2.7.jpg" width="300" height="250">
</div>
<div align=center>图7. 状态预测</div>

我们可以用矩阵 ${F_k}$ 表示这个预测步骤：

<div align=center>
<img src="./imgs/1.1.2.8.jpg" width="300" height="250">
</div>
<div align=center>图8. 矩阵表示状态</div>

它从原始预测中取每一点，并将其移动到新的预测位置。如果原始预测是正确的，系统就会移动到新位置。

这是怎么做到的？为什么我们可以用矩阵来预测机器人下一刻的位置和速度？下面是个简单公式：

$$
\color{Magenta}{P_k} = \color{Blue}{P_{k-1}} + \color{WhiteSmoke}{\triangle t}{\color{Blue}{v_{k-1}}}
$$

$$
\color{Magenta}{v_{k}} = \quad\quad\quad\quad \color{Blue}{v_{k-1}}
$$

转换成矩阵形式：

$$
\color{Magenta}{\hat{x_k}} \color{WhiteSmoke}= 
\left[
\begin{matrix}
1 & \triangle t \\
0 & 1 \\
\end{matrix}
\right]
\color{Blue}{\hat{x}_{k-1}}
$$

$$
=\quad{F_k}\color{Blue}{\hat{x}_{k-1}}
$$

这是一个预测矩阵，它能给出机器人的下一个状态，但目前我们还不知道协方差矩阵的更新方法。这也是我们要引出下面这个等式的原因：如果我们将分布中的每个点乘以矩阵A，那么它的协方差矩阵会发生什么变化

$$
Cov(x) = \Sigma
$$

$$
Cov(\color{Red}{A}\color{WhiteSmoke}{x}) = \color{Red}A \color{WhiteSmoke}{\Sigma} \color{Red}{A^T}
$$

把这个式子和上面的最佳估计 $\hat{x}$ 结合，可得：

$$
\color{Red}{\hat{x}} \color{WhiteSmoke} = {F_k} \color{Blue}{\hat{x}_{k-1}}
$$

$$
\color{Red}{P_k} \color{WhiteSmoke} = \color{WhiteSmoke}{{F_k}} \color{Blue}{P_{k-1}} \color{WhiteSmoke}{F_k^T}
$$






